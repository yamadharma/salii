#/bin/sh
#
# Author: Bas van der Vlies & Dennis Stam
# Date  : 28 Juni 2010 & 9 august 2011
# Desc. : Copy the needed libraries in the initrd. A simple mklibs replacement
#
# SVn Info:
# 	$Id$
#       $URL: https://subtrac.sara.nl/oss/svn/sali/trunk/initrd/copy_libs $
#
#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with this program; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
if [ $# -lt 1 ]
then
	echo "Usage: $(basename $0) <sali_lib_path> <executable_path>"
	echo
	echo " Modes: byfiles or bypath"
	echo
	echo " Specify paths as: lib/:usr/lib/"
	exit 0
fi

## Some definiction given by the user
SALIPATH=$(echo $1|tr ':' ' ')
FILES=$(find $(echo $2|tr ':' ' '))
TARGETDIR=$3

## A function to check if we already have the lib
check_exists() {
	for path in $(echo $SALIPATH)
	do
		if [ -e "${path}/${1}" ]
		then
			return
		fi
	done

	echo "${1}"
}

## Loop through the files
for f in  $FILES
do
	## Check if it's a regular file
	if [ -f "${f}" ]
	then
		## Loop through the SALI lib paths
		for libpath in $(ldd $f  | awk '{ print $3 }' | grep ^/)
		do
			if [ -n "$(check_exists $(basename $libpath))" ]
			then
				NAME=$(basename $libpath)
				PATH=$(echo $libpath|sed 's/'${NAME}'//')
				echo "Copying lib from ${libpath} to ${TARGETDIR}/${PATH}"
				cp ${libpath} ${TARGETDIR}/${PATH}
			fi
		done
	fi
done | sort | uniq
