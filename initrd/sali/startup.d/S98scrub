
. /etc/init.d/functions

if [ "x${SCRUB}" == "xy" ]
then

    if [ -z "${SCRUB_DISKS}" ]
    then
        SCRUB_DISKS=all
    fi
    
    case "${SCRUB_DISKS}" in
        all)
            p_stage "Starting SCRUB for all disks"

            disk_enumerate "sd hd cciss"

            p_comment 2 "Found '${NUMDISKS}' to scrub"

            for disk in $(seq 0 1 $(( $NUMDISKS -1 )))
            do
                p_service "SCRUB starting on disk $disk"
                eval d_name="\${DISK${disk}}"
                p_comment 2 "  scrub $SCRUB_OPTIONS $d_name"
                scrub $SCRUB_OPTIONS $d_name &
                p_comment 2 "PID of process is ${!}"
            done
        ;;
        *)
        	p_stage "Starting SCRUB for specified disks"
        	for disk in $(echo $SCRUB_DISKS|tr "," "\n")
        	do
        		p_service "SCRUB starting on disk ${disk}"
        		if [ -e "$disk" ]
        		then
        			scrub_disk=$disk
        		elif [ -e "/dev/${disk}" ]
        		then
        			scrub_disk="/dev/${disk}"
        		fi
        		
	                p_comment 2 "  scrub $SCRUB_OPTIONS $scrub_disk"
	                scrub $SCRUB_OPTIONS $scrub_disk &
	                p_comment 2 "PID of process is ${!}"
        	done
    esac

    while true
    do
        if [ -z "$(ps | grep scrub | grep -v grep)" ]
        then
            break
        else
            sleep 10
        fi
    done

    if [ "x${SCRUB_REBOOT}" == "xy" ]
    then
        p_service "Rebooting machine"
        reboot
    elif [ "x${SCRUB_HALT}" == "xy" ]
    then
        p_service "Halting machine"
        halt
    fi

fi
