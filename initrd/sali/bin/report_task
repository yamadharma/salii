#!/bin/sh

. /etc/init.d/functions
. /tmp/variables.txt

case "${PROTOCOL}" in
    bittorrent|metafile)
        #Starting actual reporting daemon
        while true
        do

            SPEED=$(aria_get_rpc_speed $ARIA_LOG)
            PROGRESS=$(aria_get_rpc_progress $ARIA_LOG)

            if [ -z "${SPEED}" ]
            then
                SPEED=0
            fi
                
            # Convert bytes to kilo bytes, when amount of bytes is
            # lower then 1024, report 0
            if [ $SPEED -lt 1024 ]
            then
                SPEED=0
            else
                SPEED=$(echo "scale=2; ( ${SPEED} / 1024 )" | bc)
            fi

            if [ $PROGRESS -ge 90 ]
            then
                send_monitor_msg "status=90:speed=${SPEED}"
            else
                send_monitor_msg "status=${PROGRESS}:speed=${SPEED}"
            fi

            if [ "x$DONE" = "xtrue" ]
            then
                break
            fi

            sleep 10
        done
    ;;
    rsync)
        IMAGESIZE=$(rsync -a --verbose --dry-run --numeric-ids $IMAGESERVER::$IMAGENAME|grep "total size"|awk '{print $4}')
        IMAGESIZE=$(( $IMAGESIZE / 1024 ))
        PREVSIZE=0

        while true
        do
            if [ -e "/a" ]
            then
                #CURSIZE=$(df 2>/dev/null | grep "/a" | awk '{ print $3}' | sed -ne 's/^\([0-9]*\)$/\1+/p')0
                #CURSIZE=$(echo $CURSIZE|bc)

                CURSIZE=$(du -sk /a 2>/dev/null| awk '{ print $1 }')

                PERCENT=$(echo "scale=2; ($CURSIZE / $IMAGESIZE) * 100"| bc)
                SPEED=$(echo "scale=2; ($CURSIZE - $PREVSIZE) / 10" | bc)

                if [ $(echo "scale=2; $PERCENT <= 0" | bc) -eq 1 ]
                then
                    PERCENT=1
                elif [ $(echo "scale=2; $PERCENT >= 100" | bc) -eq 1 ]
                then
                    PERCENT=99
                fi

                send_monitor_msg "status=${PERCENT}:speed=${SPEED}"

                if [ $CURSIZE -gt $IMAGESIZE ]
                then
                    break
                fi

                PREVSIZE=$CURSIZE

                sleep 10
            else
                sleep 5
            fi
        done
    ;;
    *)
        p_comment 0 "Given protocol is not supported"
    ;;
esac
