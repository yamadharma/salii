
p_stage "Final preparations"

p_service "Loaded modules"
for module in $(cat /proc/modules | awk '{print $1}')
do
	p_comment 0 "${module}"
done

if [ "x${RESCUE}" != "xyes" ]
then

    p_service "Checking for SystemImager specific things"

    ping_test_imageserver
    if [ ! $PING_SERVER -eq 0 ]
    then
        p_comment 0 "Unable to ping image server, check variable IMAGESERVER"
        return 1
    fi

    if [ -z "${SCRIPTNAME}" -a -z "${IMAGENAME}" -a -z "${HOSTNAME}" ]
    then
	    p_comment 0 "Could not found any of the following variables:"
    	p_comment 0 "  - SCRIPNAME"
    	p_comment 0 "  - IMAGENAME"
    	p_comment 0 "  - HOSTNAME"
    	p_comment 0 "We need these variables for determing which image must be installed"
    	p_comment 0 ""
    	p_comment 0 "This message can be ignored when you wan't a rescue shell"
    	return 1
    fi

    p_comment 0 "Using old method: choose_autoinstall_script()"
    choose_autoinstall_script()

    p_comment 0 "Scriptname: ${SCRIPTNAME}, imagename: ${IMAGENAME}, hostname: ${HOSTNAME}"

    save_param SCRIPTNAME $SCRIPTNAME
    save_param IMAGENAME $IMAGENAME
    
    if [ -z "${PROTOCOL}" ]
    then
    	p_comment 0 "\$PROTOCOL variable is not set, using deprecated installation method\!"
    	old_getimage
    fi
fi

return 0
