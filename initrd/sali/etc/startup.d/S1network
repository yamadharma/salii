
p_stage "Configuring network"

## First we configure the loopback device
p_service "Enabling loopback device"
do_ifup lo

if [ -n "${DEVICE}" ]
then
    p_service "Configuring interface ${DEVICE}"

    if [ -n "${IPADDR}" -a -n "${NETMASK}" ]
    then
        p_comment 0 "Static configuration with ip ${IPADDR} and netmask ${NETMASK}"

        echo "auto ${DEVICE}" >> /etc/network/interfaces
        echo "iface ${DEVICE} inet static" >> /etc/network/interfaces
        echo "    address ${IPADDR}" >> /etc/network/interfaces
        echo "    netmask ${NETMASK}" >> /etc/network/interfaces

        save_param IPADDR $IPADDR
        save_param NETMASK $NETMASK

        if [ -n "${NETWORK}" ]
        then
            echo "    network ${NETWORK}" >> /etc/network/interfaces
            save_param NETWORK $NETWORK
        fi

        if [ -n "${BROADCAST}" ]
        then
            echo "    broadcast ${BROADCAST}" >> /etc/network/interfaces
            save_param BROADCAST $BROADCAST
        fi
        echo "" >> /etc/network/interfaces

        if [ -n "${NAMESERVER}" ]
        then
            echo "nameserver ${NAMESERVER}" > /etc/resolv.conf
            save_param NAMESERVER $NAMESERVER
            if [ -n "${DOMAIN}" ]
            then
                echo "domain ${DOMAIN}" >> /etc/resolv.conf
                save_param NAMESERVER $NAMESERVER
            fi
        else
            p_comment 0 "Unable to create a resolv.conf file"
        fi

    else
        p_comment 0 "Using DHCP"
        
        echo "auto ${DEVICE}" >> /etc/network/interfaces
        echo "iface ${DEVICE} inet dhcp" >> /etc/network/interfaces
        echo "" >> /etc/network/interfaces
    fi

    do_ifup $DEVICE

    if [ ! $? -eq 0 ]
    then
        p_comment 0 "Unable to configure network device ${DEVICE}"
        return 1
    fi
    
    if [ -n "${GATEWAY}" ]
    then
        p_comment 0 "Trying to set default gateway to ${GATEWAY}"
        do_gateway $GATEWAY

        if [ ! $? -eq 0 ]
        then
            p_comment 0 "Unable to configure default route"
        fi
    fi
else
    p_service "Configuring all network interfaces with DHCP"

    for NIC in $(ls -1 /sys/class/net | grep -v lo)
    do
        echo "auto ${NIC}" >> /etc/network/interfaces
        echo "iface ${NIC} inet dhcp" >> /etc/network/interfaces
        echo "" >> /etc/network/interfaces
    done

    for NIC in $(ls -1 /sys/class/net | grep -v lo)
    do
        {
            p_comment 0 "Configuring interface ${NIC}"
            do_ifup $NIC

            if [ $? -eq 0 ]
            then
                p_comment 0 "Interface $NIC configured"
                echo "$NIC" > /tmp/nics_configured
            else
                p_comment 0 "Interface $NIC failed"
            fi
        } &
    done

    # Wait to finish
    wait 

    if [ $(wc -l /tmp/nics_configured | awk '{print $1}') -eq 0 ]
    then
        p_service "No network connection found!"
        return 1
    fi
fi

if [ -z "${HOSTNAME}" ]
then
	HOSTNAME=$(hostname)
fi

return 0
