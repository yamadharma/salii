#
#	"SALI"  
#
#   Copyright (C) 2010 SARA Computing and Networking Services
#   
#   $Id$
# 	 vi: set filetype=make:
#

## BEGIN General options
#
VERSION=$(shell cat VERSION)

ARCH=@ARCH@
ARCH_BIT=@ARCH_BIT@
OS=@OS@
OS_RELEASE=@OS_RELEASE@

RELEASE_DOCS = CHANGELOG LICENSE CREDITS README VERSION
NCPUS=$(shell egrep -c '^processor' /proc/cpuinfo )
#
## END General options

## BEGIN location options
#
ROOT_DIR=$(CURDIR)

# The basic
MAKED_DIR=$(ROOT_DIR)/make.d
PATCH_DIR=$(ROOT_DIR)/patches
SRC_DIR=$(ROOT_DIR)/src
STAMP_DIR=$(SRC_DIR)

# The initrd locations
INITRD_DIR=$(ROOT_DIR)/initrd
INITRD_MAKED_DIR=$(INITRD_DIR)/make.d
INITRD_PATCH_DIR=$(INITRD_DIR)/patches
INITRD_BUILD_DIR=$(INITRD_DIR)/build_dir

INITRD_BUILD_MAN_DIR=$(INITRD_BUILD_DIR)/usr/share/man
INITRD_BUILD_BIN_DIR=$(INITRD_BUILD_DIR)/bin
INITRD_BUILD_SBIN_DIR=$(INITRD_BUILD_DIR)/sbin
#
## END location options

## BEGIN utilities
#
GETSOURCE=$(ROOT_DIR)/tools/getsource
COPYLIBS=$(ROOT_DIR)/tools/copy_libs
#
## END utilities

include $(ROOT_DIR)/make.d/kernel.rul
include $(ROOT_DIR)/make.d/zlib.rul
include $(ROOT_DIR)/initrd/initrd.rul

.PHONY: prepare
prepare: $(INITRD_BUILD_DIR).prep

$(INITRD_BUILD_DIR).prep:  $(INITRD_DIR)/initrd.rul

	rm -rf $(INITRD_BUILD_DIR)

	mkdir -p $(INITRD_BUILD_DIR)
	mkdir -p -m 0755 $(INITRD_BUILD_DIR)/bin
	mkdir -p -m 0755 $(INITRD_BUILD_DIR)/sbin
	mkdir -p -m 0755 $(INITRD_BUILD_DIR)/etc
	mkdir -p -m 0755 $(INITRD_BUILD_DIR)/dev
	mkdir -p -m 0755 $(INITRD_BUILD_DIR)/lib
	mkdir -p -m 0755 $(INITRD_BUILD_DIR)/proc
	mkdir -p -m 0755 $(INITRD_BUILD_DIR)/bin
	mkdir -p -m 0755 $(INITRD_BUILD_DIR)/tmp
	mkdir -p -m 0755 $(INITRD_BUILD_DIR)/var
	mkdir -p -m 0755 $(INITRD_BUILD_DIR)/var/log
	mkdir -p -m 0755 $(INITRD_BUILD_DIR)/var/run
	mkdir -p -m 0755 $(INITRD_BUILD_DIR)/usr

	test ! -d /lib64 || ( cd $(INITRD_BUILD_DIR) && ln -s lib lib64 )

	mknod -m 666 $(INITRD_BUILD_DIR)/dev/tty0 c 4 0
	mknod -m 666 $(INITRD_BUILD_DIR)/dev/tty1 c 4 1
	mknod -m 666 $(INITRD_BUILD_DIR)/dev/tty2 c 4 2
	mknod -m 666 $(INITRD_BUILD_DIR)/dev/tty3 c 4 3
	mknod -m 666 $(INITRD_BUILD_DIR)/dev/tty4 c 4 4
	mknod -m 666 $(INITRD_BUILD_DIR)/dev/tty5 c 4 5
	mknod -m 666 $(INITRD_BUILD_DIR)/dev/tty6 c 4 6
	mknod -m 666 $(INITRD_BUILD_DIR)/dev/console c 5 1
	mknod -m 666 $(INITRD_BUILD_DIR)/dev/null c 1 3
	mknod -m 666 $(INITRD_BUILD_DIR)/dev/zero c 1 5

	chmod +x $(INITRD_DIR)/sali/bin/sali_functions

	touch $@

# build everything, install nothing
.PHONY:	build
build:	kernel initrd

.PHONY:	help
help:  show_targets

.PHONY: sali
sali: build
	make INSTALL_MOD_PATH=$(INITRD_BUILD_DIR) -C $(LINUX_DIR) modules_install

.PHONY: distclean
distclean: initrd_clean

	@echo "\nCLEAN:: Removing generic files"
	rm -rf $(ROOT_DIR)/src
	rm -r Makefile config.log config.status

.PHONY:	show_targets
show_targets:
	@echo
	@echo "General commands:"
	@echo " build"
	@echo "    Build everything. Does not install the kernel modules"
	@echo " kernel"
	@echo "    Only build the kernel."
	@echo " initrd"
	@echo "    Builds the software for the initrd, skips kernel build!"
	@echo " sali"
	@echo "    Builds the kernel and initrd. Also installs the kernel modules."
	@echo " tarball"
	@echo "    Same as sali but creates a tar.gz with the initrd.img and kernel."
	@echo
	@echo "Dynamic commands (available when imported in initrd.rul):"
	@echo " <name>"
	@echo "    Retrieve and build the .rul package in the directory $(SRC_DIR)"
	@echo " <name>_install"
	@echo "    Installs the .rul package to $(INITRD_BUILD_DIR)"
	@echo " <name>_clean"
	@echo "    Cleans the files of a .rul package in $(SRC_DIR)"

all: show_targets
