#
#	"SALI"  
#
#   Copyright (C) 2010 SARA Computing and Networking Services
#   
#   $Id$
# 	 vi: set filetype=make:
#

## BEGIN General options
#
VERSION=$(shell cat VERSION)

ARCH=@ARCH@
ARCH_BIT=@ARCH_BIT@
OS=@OS@
OS_RELEASE=@OS_RELEASE@

ifeq ($(ARCH_BIT),64)
	LIBDIR=lib64
else
	LIBDIR=lib
endif

RELEASE_DOCS = CHANGELOG LICENSE CREDITS README VERSION
NCPUS=$(shell egrep -c '^processor' /proc/cpuinfo )
#
## END General options

## BEGIN location options
#
ROOT_DIR=$(CURDIR)

# The basic
MAKED_DIR=$(ROOT_DIR)/make.d
PATCH_DIR=$(ROOT_DIR)/patches
SRC_DIR=$(ROOT_DIR)/src
STAMP_DIR=$(SRC_DIR)

# The initrd locations
INITRD_DIR=$(ROOT_DIR)/initrd
INITRD_MAKED_DIR=$(INITRD_DIR)/make.d
INITRD_PATCH_DIR=$(INITRD_DIR)/patches
INITRD_BUILD_DIR=$(INITRD_DIR)/build_dir

INITRD_BUILD_MAN_DIR=$(INITRD_BUILD_DIR)/usr/share/man
INITRD_BUILD_BIN_DIR=$(INITRD_BUILD_DIR)/bin
INITRD_BUILD_SBIN_DIR=$(INITRD_BUILD_DIR)/sbin
#
## END location options

## BEGIN utilities
#
GETSOURCE=$(ROOT_DIR)/tools/getsource
COPYLIBS=$(ROOT_DIR)/tools/copy_libs
#
## END utilities

include $(ROOT_DIR)/make.d/kernel.rul
include $(ROOT_DIR)/make.d/zlib.rul
include $(ROOT_DIR)/initrd/initrd.rul

# build everything, install nothing
.PHONY:	build
build:	kernel modules initrd_install

	( mkdir -p -m 0755 $(ROOT_DIR)/build/$(ARCH) )

	( make INSTALL_MOD_PATH=$(INITRD_BUILD_DIR) -C $(LINUX_DIR) modules_install )
	( cd "$(INITRD_BUILD_DIR)" && find . | cpio --quiet -o -H newc > "$(ROOT_DIR)/build/$(ARCH)/initrd" )
	( cd "$(ROOT_DIR)/build/$(ARCH)" && bzip2 --best --force initrd && mv initrd.bz2 initrd.img )
	( cp "$(LINUX_IMAGE)" "$(ROOT_DIR)/build/$(ARCH)/kernel" )

	touch $@

ifeq ($(OS),suse) 
	( cp "$(LINUX_DIR)/vmlinux" "$(ROOT_DIR)/build/$(ARCH)/vmlinux" )
	mkzimage --vmlinux "$(ROOT_DIR)/build/$(ARCH)/vmlinux" --initrd "$(ROOT_DIR)/build/$(ARCH)/initrd.img" --output "$(ROOT_DIR)/build/$(ARCH)/vmlinuz" 
endif

	$(foreach doc, $(RELEASE_DOCS), cp $(ROOT_DIR)/$(doc) $(ROOT_DIR)/build/$(doc);)

.PHONY: tarball
tarball: build
	cd $(ROOT_DIR)/build && tar -pczf $(ROOT_DIR)/sali-$(ARCH)-$(VERSION).tar.gz *

.PHONY:	help
help:  show_targets

.PHONY: distclean
distclean: initrd_clean

	@echo "\nCLEAN:: Removing generic files"
	rm -rf $(ROOT_DIR)/src
	rm -rf $(ROOT_DIR)/build
	rm -r Makefile config.log config.status

.PHONY:	show_targets
show_targets:
	@echo
	@echo "General commands:"
	@echo " build"
	@echo "    Build everything."
	@echo " kernel"
	@echo "    Only build the kernel."
	@echo " initrd"
	@echo "    Builds the software for the initrd, skips kernel build!"
	@echo " tarball"
	@echo "    Make a tarball with the contents from ROOT_DIR/build."
	@echo
	@echo "Dynamic commands (available when imported in initrd.rul):"
	@echo " <name>"
	@echo "    Retrieve and build the .rul package in the directory $(SRC_DIR)"
	@echo " <name>_install"
	@echo "    Installs the .rul package to $(INITRD_BUILD_DIR)"
	@echo " <name>_clean"
	@echo "    Cleans the files of a .rul package in $(SRC_DIR)"

all: show_targets
