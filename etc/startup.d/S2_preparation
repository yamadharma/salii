
## Welcome message for the preparation stage
p_stage "Preparing SALI"

if [ -z "${SALI_MASTERSCRIPT}" ]
then
    ## Default behaviour if you are using the SALI server tools
    SALI_MASTERSCRIPT="http://${SALI_IMAGESERVER}/master_script"
fi

p_service "Trying to fetch master_script"
p_comment 10 "from ${SALI_MASTERSCRIPT}"
download_masterscript $SALI_MASTERSCRIPT

## No panic we don't have the master script
if [ -e "${SALI_CACHE_DIR}/master_script" ]
then
    supported_script "${SALI_CACHE_DIR}/master_script"
    if [ $? -ne 0 ]
    then
        p_comment 0 "The downloaded master_script is not supported by SALI ${SALI_VERSION}"
        return 1
    fi
    
    . "${SALI_CACHE_DIR}/master_script"
    check_function_exists initialize partition
    if [ $? -ne 0 ]
    then
        p_comment 0 "Missing functions initialize and/or partition in the master_script"
        return 1
    fi
    
    p_service "Initialize SALI with configuration from master_script"
    initialize
else
    p_comment 0 "Unable to retrieve master_script, continue to boot"
fi
